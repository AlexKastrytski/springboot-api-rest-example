name: CI/CD STAGING

on:
  workflow_dispatch:
  
  push:
    branches: [ development ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸš€ Deploy in EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_EC2_HOSTNAME }}
          username: ${{ secrets.AWS_EC2_USERNAME }}
          key: ${{ secrets.AWS_EC2_PRIVATE_KEY }}
          port: 22
          script: |
            echo "ðŸ‘€ deploy started"
            echo " "
            echo "ðŸ”¨ updating repository"
            echo " "
            cd /home/ubuntu/repository
            eval `ssh-agent -s`
            ssh-add ~/.ssh/github_action
            git checkout development -f
            git fetch
            git pull
            echo "ðŸ“¦ building docker image"
            echo " "
            DOCKER_BUILDKIT=1 docker build -t spring-crud-api:development .
            echo "ðŸš¨ restarting container"
            echo " "
            cd /home/ubuntu
            docker-compose up -d --force-recreate
            echo "ðŸš€ deploy finished"